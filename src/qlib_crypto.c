/************************************************************************************************************
* @internal
* @remark     Winbond Electronics Corporation - Confidential
* @copyright  Copyright (c) 2019 by Winbond Electronics Corporation . All rights reserved
* @endinternal
*
* @file       qlib_crypto.c
* @brief      This file contains QLIB cryptographic functions
*
* ### project qlib
*
************************************************************************************************************/

/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
/*                                                INCLUDES                                                 */
/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
#include "qlib_crypto.h"

/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
/*                                               DEFINITIONS                                               */
/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
#define QLIB_CRYPTO_HASH_BUFFER_SIZE 55

/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
/*                                                 MACROS                                                  */
/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
#define QLIB_CRYPTO_HASH_BUFFER_CTRL(buf_32, b1, b2, b3)              \
    {                                                                 \
        ((U8*)(buf_32))[QLIB_CRYPTO_HASH_BUFFER_SIZE - 3] = (U8)(b1); \
        ((U8*)(buf_32))[QLIB_CRYPTO_HASH_BUFFER_SIZE - 2] = (U8)(b2); \
        ((U8*)(buf_32))[QLIB_CRYPTO_HASH_BUFFER_SIZE - 1] = (U8)(b3); \
    }

/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/
/*                                           INTERFACE FUNCTIONS                                           */
/*---------------------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------------------------------------*/

void QLIB_CRYPTO_BuildCipherKey(QLIB_HASH_BUF_T hashBuf, U8 key_id, QLIB_DIRECTION_E dir, _256BIT cipher_key)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* The cipher key is calculated as follows:                                                            */
    /* CK[255:0] = SHA ( CTRL[23:0], 288'b0, SSK[127:0] )                                                  */
    /*-----------------------------------------------------------------------------------------------------*/

    /*-----------------------------------------------------------------------------------------------------*/
    /* 288'b0                                                                                              */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_SET_INLINE(&(hashBuf[4]), 0, 9);

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTRL[23:0] is { DIR[7:0], KID[7:0], 00h }                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_CRYPTO_HASH_BUFFER_CTRL(hashBuf, 0, key_id, dir);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Perform HASH                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    (void)QLIB_HASH(cipher_key, hashBuf, QLIB_CRYPTO_HASH_BUFFER_SIZE);
}

#ifdef QLIB_HASH_OPTIMIZATION_ENABLED
void QLIB_CRYPTO_BuildCipherKey_Async(QLIB_CONTEXT_T*  qlibContext,
                                      QLIB_HASH_BUF_T  hashBuf,
                                      U8               key_id,
                                      QLIB_DIRECTION_E dir,
                                      _256BIT          cipher_key)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* The cipher key is calculated as follows:                                                            */
    /* CK[255:0] = SHA ( CTRL[23:0], 288'b0, SSK[127:0] )                                                  */
    /*-----------------------------------------------------------------------------------------------------*/

    /*-----------------------------------------------------------------------------------------------------*/
    /* 288'b0                                                                                              */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_SET_INLINE(&(hashBuf[4]), 0, 9);

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTRL[23:0] is { DIR[7:0], KID[7:0], 00h }                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_CRYPTO_HASH_BUFFER_CTRL(hashBuf, 0, key_id, dir);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Perform SHA                                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    (void)QLIB_HASH_Async(qlibContext, cipher_key, hashBuf, QLIB_CRYPTO_HASH_BUFFER_SIZE);
}
#endif

void QLIB_CRYPTO_EncryptData(U32* dst, const U32* src, const U32* cipher_key, U32 data_size)
{
    U32 i;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Verify that data is 32bit chunks                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    ASSERT(data_size % 4u == 0u)

    /*-----------------------------------------------------------------------------------------------------*/
    /* Encrypt data                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    for (i = 0; i < (data_size / sizeof(U32)); i++)
    {
        dst[i] = src[i] ^ cipher_key[i];
    }
}

void QLIB_CRYPTO_CalcAuthSignature(QLIB_HASH_BUF_T hashBuf, U8 key_id, _64BIT signature)
{
    _256BIT hash_result;

    /*-----------------------------------------------------------------------------------------------------*/
    /* S[255:0] = SHA ( CTRL[31:0], Data[255:0], CTAG[31:0], SSK[127:0] )                                  */
    /* SSK, CTAG and data are already filled by the user                                                   */
    /*-----------------------------------------------------------------------------------------------------*/

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTRL[95:0] = 00h, KID[7:0], CMD[7:0]                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_CRYPTO_HASH_BUFFER_CTRL(hashBuf, 0, key_id, QLIB_CMD_PROC__CTAG_GET_CMD(QLIB_HASH_BUF_GET__CTAG(hashBuf)));

    /*-----------------------------------------------------------------------------------------------------*/
    /* Perform HASH                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    (void)QLIB_HASH(hash_result, hashBuf, QLIB_CRYPTO_HASH_BUFFER_SIZE);

    /*-----------------------------------------------------------------------------------------------------*/
    /* copy 64 MSB for signature                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    signature[0] = hash_result[6];
    signature[1] = hash_result[7];
}

void QLIB_CRYPTO_GetProvisionKey(U8          key_id,
                                 const KEY_T Kd_128bit,
                                 BOOL        includeWID,
                                 BOOL        ignoreScrValidity,
                                 KEY_T       prov_key_128_bit)
{
    QLIB_HASH_BUF_T hash_buf;
    _256BIT         hash_result;
    U8              mode = 0;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Set mode                                                                                            */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_SEC_OPEN_CMD_MODE_SET(mode, includeWID, ignoreScrValidity);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Kd part                                                                                             */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_COPY_INLINE(hash_buf, Kd_128bit, 4);

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTAG part                                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    hash_buf[4] = QLIB_CMD_PROC__MAKE_CTAG_PARAMS(QLIB_CMD_SEC_SESSION_OPEN, key_id, mode, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* 256b0 part                                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_SET_INLINE(&(hash_buf[5]), 0, 8);

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTRL part : { CMD[7:0], 0xFF, 8'b0 }                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_CRYPTO_HASH_BUFFER_CTRL(hash_buf, 0, 0xff, QLIB_CMD_SEC_SESSION_OPEN);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Perform HASH                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    (void)QLIB_HASH(hash_result, hash_buf, QLIB_CRYPTO_HASH_BUFFER_SIZE);

    /*-----------------------------------------------------------------------------------------------------*/
    /* copy 128 LSB                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_COPY_INLINE(prov_key_128_bit, hash_result, 4);
}

void QLIB_CRYPTO_SessionKeyAndSignature(const _256BIT   key,
                                        U32             ctag,
                                        const QLIB_MC_T MC,
                                        const _64BIT    NONCE,
                                        const _64BIT    WID,
                                        _128BIT         session_key,
                                        _64BIT          cmd_sig,
                                        _64BIT          random_seed)
{
    QLIB_HASH_BUF_T hash_buf;
    _256BIT         hash_result;

    /*-----------------------------------------------------------------------------------------------------*/
    /* (K[127:0]^(MC[63:0]<<64))                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    hash_buf[0] = key[0];
    hash_buf[1] = key[1];
    hash_buf[2] = key[2] ^ MC[DMC];
    hash_buf[3] = key[3] ^ MC[TC];

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTAG[31:0] - CTAG[31:0] is the command tag (from Input Buffer):                                     */
    /*-----------------------------------------------------------------------------------------------------*/
    hash_buf[4] = ctag;

    /*-----------------------------------------------------------------------------------------------------*/
    /* NONCE[63:0]                                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    hash_buf[5] = NONCE[0];
    hash_buf[6] = NONCE[1];

    /*-----------------------------------------------------------------------------------------------------*/
    /* |WID[63:0]                                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    if (WID == NULL)
    {
        hash_buf[7] = 0;
        hash_buf[8] = 0;
    }
    else
    {
        hash_buf[7] = WID[0];
        hash_buf[8] = WID[1];
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* 128'b0                                                                                              */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_SET_INLINE(&(hash_buf[9]), 0, 4);

    /*-----------------------------------------------------------------------------------------------------*/
    /* CTRL 00h, FFh, CMD[7:0]                                                                             */
    /*-----------------------------------------------------------------------------------------------------*/
    QLIB_CRYPTO_HASH_BUFFER_CTRL(hash_buf, 0, 0xFF, QLIB_CMD_PROC__CTAG_GET_CMD(ctag));

    /*-----------------------------------------------------------------------------------------------------*/
    /* Perform HASH                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    (void)QLIB_HASH(hash_result, hash_buf, QLIB_CRYPTO_HASH_BUFFER_SIZE);

    /*-----------------------------------------------------------------------------------------------------*/
    /* copy 128 LSB for SK                                                                                 */
    /*-----------------------------------------------------------------------------------------------------*/
    if (session_key != NULL)
    {
        ARRAY_COPY_INLINE(session_key, hash_result, 4);
    }
    /*-----------------------------------------------------------------------------------------------------*/
    /* copy 128-192 to random seed                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    if (random_seed != NULL)
    {
        ARRAY_COPY_INLINE(random_seed, &hash_result[4], 2);
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* copy 192 - 255 for CMD SIG                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    ARRAY_COPY_INLINE(cmd_sig, &hash_result[6], 2);
}

void QLIB_CRYPTO_Reseed(QLIB_PRNG_STATE_T* prng)
{
    prng->state ^= PLAT_GetNONCE();
    prng->count = QLIB_PRNG_RESEED_COUNT;
}

U32 QLIB_CRYPTO_GetRand32(QLIB_PRNG_STATE_T* prng)
{
    if ((prng->count == 0u) || (prng->state == 0u))
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* Seed if needed                                                                                  */
        /*-------------------------------------------------------------------------------------------------*/
        QLIB_CRYPTO_Reseed(prng);
    }
    else
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* Xorshift                                                                                        */
        /*-------------------------------------------------------------------------------------------------*/
        prng->state ^= prng->state << 13;
        prng->state ^= prng->state >> 7;
        prng->state ^= prng->state << 17;

        prng->count--;
    }

    return (U32)(prng->state);
}
